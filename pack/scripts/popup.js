class C{name;controller;signal;static storage;constructor($){if(!C.storage)try{C.storage=chrome.storage}catch{try{C.storage=browser.storage}catch{throw"Unsupported browser"}}this.name=$.name,this.controller=new AbortController,this.signal=this.controller.signal,this.sessions=this.createStore("sessions",({token:J})=>{if(J.refresh)return null;return J.expires_at??null}),this.states=this.createStore("states",(J)=>Date.now()+600000),this.dpopNonces=this.createStore("dpopNonces",(J)=>Date.now()+600000)}sessions;states;dpopNonces;dispose(){this.controller.abort()}createStore($,J){let V=`${this.name}:${$}`,X=async(W)=>{try{await C.storage.local.set({[V]:W})}catch(H){console.error("Error persisting storage:",H)}},Z=async()=>{if(this.signal.aborted)throw new Error("store closed");try{return(await C.storage.local.get(V))[V]||{}}catch(W){return console.error("Error reading storage:",W),{}}},Q=null;return Q=setInterval(async()=>{if(this.signal.aborted)return;try{let W=await Z(),H=Date.now(),Y=!1;for(let q in W){let x=W[q].expiresAt;if(x!==null&&H>x)Y=!0,delete W[q]}if(Y)await X(W)}catch(W){if(W.message.includes("Extension context invalidated.")){if(Q)clearInterval(Q);return}console.error("Error during cleanup:",W)}},1e4),this.signal.addEventListener("abort",()=>clearInterval(Q)),{async get(W){let H=await Z(),Y=H[W];if(!Y)return;let q=Y.expiresAt;if(q!==null&&Date.now()>q){delete H[W],await X(H);return}return Y.value},async set(W,H){let Y=await Z();Y[W]={expiresAt:J(H),value:H},await X(Y)},async delete(W){let H=await Z();if(H[W]!==void 0)delete H[W],await X(H)},async keys(){let W=await Z();return Object.keys(W)}}}}var T,k,f,S=($)=>{({client_id:T,redirect_uri:k}=$.metadata),f=new C({name:$.storageName??"atcute-oauth"})};class N extends Error{name="ResolverError"}class L extends Error{sub;name="TokenRefreshError";constructor($,J,V){super(J,V);this.sub=$}}class m extends Error{response;data;name="OAuthResponseError";error;description;constructor($,J){let V=t(s(J)?.error),X=t(s(J)?.error_description),Z=V?`"${V}"`:"unknown",Q=X?`: ${X}`:"",G=`OAuth ${Z} error${Q}`;super(G);this.response=$,this.data=J,this.error=V,this.description=X}get status(){return this.response.status}get headers(){return this.response.headers}}class l extends Error{response;status;name="FetchResponseError";constructor($,J,V){super(V);this.response=$,this.status=J}}var t=($)=>{return typeof $==="string"?$:void 0},s=($)=>{return typeof $==="object"&&$!==null&&!Array.isArray($)?$:void 0};var e=($)=>{return f$($,"#atproto_pds","AtprotoPersonalDataServer")},f$=($,J,V)=>{let Z=$.id+J,Q=$.service?.find((G)=>G.id===J||G.id===Z);if(!Q||Q.type!==V||typeof Q.serviceEndpoint!=="string")return;return C$(Q.serviceEndpoint)},C$=($)=>{let J;try{J=new URL($)}catch{return}let V=J.protocol;if(J.hostname&&(V==="http:"||V==="https:"))return $};var $$="https://public.api.bsky.app";var A=($)=>{return $.get("content-type")?.split(";")[0]};var J$=($)=>{return $.startsWith("did:")};var T$=/^([a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*(?:\.[a-zA-Z]{2,}))$/,L$=async($)=>{let J=$$+`/xrpc/com.atproto.identity.resolveHandle?handle=${$}`,V=await fetch(J);if(V.status===400)throw new N("domain handle not found");else if(!V.ok)throw new N("directory is unreachable");return(await V.json()).did},I$=async($)=>{let J=$.indexOf(":",4),V=$.slice(4,J),X=$.slice(J+1),Z;if(V==="plc"){let Q=await fetch(`https://plc.directory/${$}`);if(Q.status===404)throw new N("did not found in directory");else if(!Q.ok)throw new N("directory is unreachable");Z=await Q.json()}else if(V==="web"){if(!T$.test(X))throw new N("invalid identifier");let Q=await fetch(`https://${X}/.well-known/did.json`);if(!Q.ok)throw new N("did document is unreachable");Z=await Q.json()}else throw new N("unsupported did method");return Z},K$=async($)=>{let J=new URL("/.well-known/oauth-protected-resource",$),V=await fetch(J,{redirect:"manual",headers:{accept:"application/json"}});if(V.status!==200||A(V.headers)!=="application/json")throw new N("unexpected response");let X=await V.json();if(X.resource!==J.origin)throw new N("unexpected issuer");return X},A$=async($)=>{let J=new URL("/.well-known/oauth-authorization-server",$),V=await fetch(J,{redirect:"manual",headers:{accept:"application/json"}});if(V.status!==200||A(V.headers)!=="application/json")throw new N("unexpected response");let X=await V.json();if(X.issuer!==J.origin)throw new N("unexpected issuer");if(!X.client_id_metadata_document_supported)throw new N("authorization server does not support 'client_id_metadata_document'");if(!X.pushed_authorization_request_endpoint)throw new N("authorization server does not support 'pushed_authorization request'");if(X.response_types_supported){if(!X.response_types_supported.includes("code"))throw new N("authorization server does not support 'code' response type")}return X},y=async($)=>{let J;if(J$($))J=$;else J=await L$($);let V=await I$(J),X=e(V);if(!X)throw new N("missing pds endpoint");return{identity:{id:J,raw:$,pds:new URL(X)},metadata:await E$(X)}};var E$=async($)=>{let J=await K$($);if(J.authorization_servers?.length!==1)throw new N("expected exactly one authorization server in the listing");let V=J.authorization_servers[0],X=await A$(V);if(X.protected_resources){if(!X.protected_resources.includes(J.resource))throw new N("server is not in authorization server's jurisdiction")}return X};var O$="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var V$=($=21)=>{let J="",V=$;while(V--)J+=O$[Math.random()*64|0];return J};var b=new TextEncoder,u=navigator.locks,E=($)=>{let V=[];for(let X=0;X<$.byteLength;X+=32768)V.push(String.fromCharCode.apply(null,$.subarray(X,X+32768)));return btoa(V.join("")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},X$=($)=>{try{let J=atob($.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"")),V=new Uint8Array(J.length);for(let X=0;X<J.length;X++)V[X]=J.charCodeAt(X);return V}catch(J){throw new TypeError("invalid base64url",{cause:J})}},p=async($)=>{let J=b.encode($),V=await crypto.subtle.digest("SHA-256",J);return E(new Uint8Array(V))},Z$=($)=>{return E(crypto.getRandomValues(new Uint8Array($)))},Q$=()=>{return Z$(16)},W$=async()=>{let $=Z$(32);return{verifier:$,challenge:await p($),method:"S256"}};function F($,J){if($==null){J??="value is null/empty";let V=Error().stack;if(V){let X=V.split(`
`);if(X.length>2){let Z=X[2].trimStart();throw Z=Z.replace(/^at/,""),Z=Z.trimStart(),`${Z}:
${typeof $}: ${J}`}}throw`${typeof $}: ${J}`}return $}var Y$={name:"ECDSA",namedCurve:"P-256"},G$=async()=>{let $=await crypto.subtle.generateKey(Y$,!0,["sign","verify"]),J=await crypto.subtle.exportKey("pkcs8",$.privateKey),{ext:V,key_ops:X,...Z}=await crypto.subtle.exportKey("jwk",$.publicKey);return{typ:"ES256",key:E(new Uint8Array(J)),jwt:E(b.encode(JSON.stringify({typ:"dpop+jwt",alg:"ES256",jwk:Z})))}},D$=($,J)=>{let V=J.jwt,X=crypto.subtle.importKey("pkcs8",X$(J.key),Y$,!0,["sign"]),Z=(Q,G,W,H)=>{let Y=Date.now()/1000|0,q={iss:$,iat:Y,jti:V$(12),htm:Q,htu:G,nonce:W,ath:H};return E(b.encode(JSON.stringify(q)))};return async(Q,G,W,H)=>{let Y=Z(Q,G,W,H),q=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},await X,b.encode(V+"."+Y)),B=E(new Uint8Array(q));return V+"."+Y+"."+B}},v=($,J,V)=>{let X=F(f),Z=F(X.dpopNonces),Q=D$($,J);return async(G,W)=>{let H=W==null&&G instanceof Request?G:new Request(G,W),Y=H.headers.get("authorization"),q=Y?.startsWith("DPoP ")?await p(Y.slice(5)):void 0,{method:B,url:x}=H,{origin:_}=new URL(x),K;try{K=await Z.get(_)}catch{}let j=await Q(B,x,K,q);H.headers.set("dpop",j);let M=await fetch(H),U=M.headers.get("dpop-nonce");if(!U||U===K)return M;try{await Z.set(_,U)}catch{}if(!await j$(M,V))return M;if(G===H||W?.body instanceof ReadableStream)return M;let o=await Q(B,x,U,q),r=new Request(G,W);return r.headers.set("dpop",o),await fetch(r)}},j$=async($,J)=>{if(J===void 0||!J){if($.status===401){let V=$.headers.get("www-authenticate");if(V?.startsWith("DPoP"))return V.includes('error="use_dpop_nonce"')}}if(J===void 0||J){if($.status===400&&A($.headers)==="application/json")try{let V=await $.clone().json();return typeof V==="object"&&V?.error==="use_dpop_nonce"}catch{return!1}}return!1};var H$=($,J)=>{let V={};for(let X=0,Z=J.length;X<Z;X++){let Q=J[X];V[Q]=$[Q]}return V};class I{#J;#$;constructor($,J){this.#$=$,this.#J=v(T,J,!0)}async request($,J){let V=this.#$[`${$}_endpoint`];if(!V)throw new Error(`no endpoint for ${$}`);let X=await this.#J(V,{method:"post",headers:{"content-type":"application/json"},body:JSON.stringify({...J,client_id:T})});if(A(X.headers)!=="application/json")throw new l(X,2,"unexpected content-type");let Z=await X.json();if(X.ok)return Z;else throw new m(X,Z)}async revoke($){try{await this.request("revocation",{token:$})}catch{}}async exchangeCode($,J){let V=await this.request("token",{grant_type:"authorization_code",redirect_uri:k,code:$,code_verifier:J});try{return await this.#X(V)}catch(X){throw await this.revoke(V.access_token),X}}async refresh({sub:$,token:J}){if(!J.refresh)throw new L($,"no refresh token available");let V=await this.request("token",{grant_type:"refresh_token",refresh_token:J.refresh});if(!V.sub)throw new L($,"missing value for sub in token response");if($!==V.sub)throw new L($,`sub mismatch in token response; got ${V.sub}`);try{return this.#V(V)}catch(X){throw await this.revoke(V.access_token),X}}#V($){if(!$.sub)throw new TypeError("missing sub field in token response");if(!$.scope)throw new TypeError("missing scope field in token response");if($.token_type!=="DPoP")throw new TypeError("token response returned a non-dpop token");return{scope:$.scope,refresh:$.refresh_token,access:$.access_token,type:$.token_type,expires_at:typeof $.expires_in==="number"?Date.now()+$.expires_in*1000:void 0}}async#X($){let J=$.sub;if(!J)throw new TypeError("missing sub field in token response");let V=this.#V($),X=await y(J);if(X.metadata.issuer!==this.#$.issuer)throw new TypeError(`issuer mismatch; got ${X.metadata.issuer}`);return{token:V,info:{sub:J,aud:X.identity.pds.href,server:H$(X.metadata,["issuer","authorization_endpoint","introspection_endpoint","pushed_authorization_request_endpoint","revocation_endpoint","token_endpoint"])}}}}var g=new Map,R=async($,J)=>{J?.signal?.throwIfAborted();let V=S$;if(J?.noCache)V=b$;else if(J?.allowStale)V=m$;let X;while(X=g.get($)){try{let{isFresh:W,value:H}=await X;if(W||V(H))return H}catch{}J?.signal?.throwIfAborted()}let Z=async()=>{let W=F(f),Y=await F(W.sessions).get($);if(Y&&V(Y))return{isFresh:!1,value:Y};let q=await R$($,Y);return await k$($,q),{isFresh:!0,value:q}},Q;if(u)Q=u.request(`atcute-oauth:${$}`,Z);else Q=Z();if(Q=Q.finally(()=>g.delete($)),g.has($))throw new Error("concurrent request for the same key");g.set($,Q);let{value:G}=await Q;return G},k$=async($,J)=>{try{let V=F(f);await F(V.sessions).set($,J)}catch(V){throw await h$(J),V}},c=async($)=>{let J=F(f);await F(J.sessions).delete($)};var m$=()=>!0,b$=()=>!1,R$=async($,J)=>{if(J===void 0)throw new L($,"session deleted by another tab");let{dpopKey:V,info:X,token:Z}=J,Q=new I(X.server,V);try{let G=await Q.refresh({sub:X.sub,token:Z});return{dpopKey:V,info:X,token:G}}catch(G){if(G instanceof m&&G.status===400&&G.error==="invalid_grant")throw new L($,"session was revoked",{cause:G});throw G}},h$=async({dpopKey:$,info:J,token:V})=>{await new I(J.server,$).revoke(V.refresh??V.access)},S$=({token:$})=>{let J=$.expires_at;return J==null||Date.now()+60000<=J};var w$=async({metadata:$,identity:J,scope:V})=>{let X=Q$(),Z=await W$(),Q=await G$(),G={redirect_uri:k,code_challenge:Z.challenge,code_challenge_method:Z.method,state:X,login_hint:J?.raw,response_mode:"fragment",response_type:"code",display:"page",scope:V},W=F(f);await F(W.states).set(X,{dpopKey:Q,metadata:$,verifier:Z.verifier});let q=await new I($,Q).request("pushed_authorization_request",G),B=new URL($.authorization_endpoint);return B.searchParams.set("client_id",T),B.searchParams.set("request_uri",q.request_uri),B};class d{session;#J;#$;constructor($){this.session=$,this.#J=v(T,$.dpopKey,!1)}get sub(){return this.session.info.sub}getSession($){let J=R(this.session.info.sub,$);return J.then((V)=>{this.session=V}).finally(()=>{this.#$=void 0}),this.#$=J}async signOut(){let $=this.session.info.sub;try{let{dpopKey:J,info:V,token:X}=await R($,{allowStale:!0});await new I(V.server,J).revoke(X.refresh??X.access)}finally{await c($)}}async handle($,J){await this.#$;let V=new Headers(J?.headers),X=this.session,Z=new URL($,X.info.aud);V.set("authorization",`${X.token.type} ${X.token.access}`);let Q=await this.#J(Z,{...J,headers:V});if(!y$(Q))return Q;try{if(this.#$)X=await this.#$;else X=await this.getSession()}catch{return Q}if(J?.body instanceof ReadableStream)return Q;return Z=new URL($,X.info.aud),V.set("authorization",`${X.token.type} ${X.token.access}`),await this.#J(Z,{...J,headers:V})}}var y$=($)=>{if($.status!==401)return!1;let J=$.headers.get("www-authenticate");return J!=null&&(J.startsWith("Bearer ")||J.startsWith("DPoP "))&&J.includes('error="invalid_token"')};function w($,J){if($==null){J??="value is null/empty";let V=Error().stack;if(V){let X=V.split(`
`);if(X.length>2){let Z=X[2].trimStart();throw Z=Z.replace(/^at/,""),Z=Z.trimStart(),`${Z}:
${typeof $}: ${J}`}}throw`${typeof $}: ${J}`}return $}function q$($){console.error($)}function z$($){let J=window.open($,"_blank");if(J)J.focus();return J}class i{container;timer;constructor(){this.timer=null,this.container=document.createElement("div"),this.container.classList.add("biskuvi-toast-container"),document.body.appendChild(this.container)}show($,J="info",V=3000){if(document.hidden)return;if(this.timer)clearTimeout(this.timer);let X=new N$($,J),Z=this.container.lastChild;if(Z)try{this.container.removeChild(Z)}catch(Q){if(Q.name!=="NotFoundError")q$(Q)}this.timer=setTimeout(()=>{X.element.style.animation="slideOut 250ms ease-in",setTimeout(()=>{this.container.removeChild(X.element)},250)},V),this.container.appendChild(X.element)}}class N${element;constructor($,J){this.element=document.createElement("div"),this.element.classList.add("biskuvi-toast",J),this.element.textContent=$}}var z={userHandle:"biskuvi_user_handle",userDid:"biskuvi_user_did",language:"biskuvi_language",colorScheme:"biskuvi_color_scheme",bookmarkServerUrl:"biskuvi_bookmark_server_url",bookmarkFeedUrl:"biskuvi_bookmark_feed_url",clientMetadataJsonUrl:"biskuvi_client_metadata_json_url",oauthCallbackUrl:"biskuvi_oauth_callback_url"};async function P$($){switch($){case 1:return new B$}throw"Not implemented"}class B${async isBookmarked($){return(await(await this.fetch("/xrpc/app.biskuvi.bookmark.isBookmarked",$)).json()).is_bookmarked===!0}async arePostsBookmarked($){let V=await(await this.fetch("/xrpc/app.biskuvi.bookmark.arePostsBookmarked",null,{uris:$})).json();return w(V.uris)}async addBookmark($){await this.fetch("/xrpc/app.biskuvi.bookmark.addBookmark",$)}async removeBookmark($){await this.fetch("/xrpc/app.biskuvi.bookmark.removeBookmark",$)}async fetch($,J,V){let X=w(P.bookmarkServerUrl)+$;if(J)X+=`?uri=${J}`;let Z=w(P.oAuthUserAgent),Q;if(V)Q=await Z.handle(X,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(V)});else Q=await Z.handle(X);if(!Q.ok)throw new Error("Invalid response status");return Q}}function g$(){try{return w(chrome)}catch{try{return w(browser)}catch{throw"Unsupported browser"}}}var a=g$();async function F$($){return await a.storage.local.set($)}async function h($,J=[]){let V=$;if(J.length>0)V=V.filter((X)=>!J.includes(X));return await a.storage.local.get(V)}async function _$($){return await a.storage.local.remove($)}var M$={bskyUrl:"https://bsky.app",bookmarkPageUrlAlias:"/bookmarks",handleResolverUrl:"https://api.bsky.app",didResolverUrl:"https://plc.directory"};var O={language:"en",bookmarkServerUrl:"https://bookmarks.bskv.site",bookmarkFeedUrl:"https://bsky.app/profile/bookmarks.bskv.site/feed/bookmarks",clientMetadataJsonUrl:"https://bskv.site/client-metadata.json",oauthCallbackUrl:"https://bskv.site/atproto-oauth-callback"};class P{static userDid;static userHandle;static language;static bookmarkServerUrl;static bookmarkFeedUrl;static clientMetadataJsonUrl;static oauthCallbackUrl;static root;static oAuthSession;static oAuthUserAgent;static bookmarkManager;static toaster;static fallbackIsBookmarked;static async init(){P.bookmarkManager=await P$(1);let $=await h(Object.values(z));P.userDid=$[z.userDid],P.language=$[z.language]||O.language,P.bookmarkServerUrl=$[z.bookmarkServerUrl]||O.bookmarkServerUrl,P.bookmarkFeedUrl=$[z.bookmarkFeedUrl]||O.bookmarkFeedUrl,P.clientMetadataJsonUrl=$[z.clientMetadataJsonUrl]||O.clientMetadataJsonUrl,P.oauthCallbackUrl=$[z.oauthCallbackUrl]||O.oauthCallbackUrl,P.toaster=new i}}function x$($,J){let V=document.body;if(document.documentElement.style.colorScheme=J,V.classList.add(J),J!="light")$.checked=!0;setTimeout((X)=>{let Z=document.documentElement.style.colorScheme;document.documentElement.style.cssText+=`color-scheme: ${Z}; --trTime: 0.3s;`},1000),$.addEventListener("change",async()=>{let X=V.classList.contains("dark")?"dark":"light",Z=X=="light"?"dark":"light";V.classList.replace(X,Z),document.documentElement.style.colorScheme=Z,await F$({[z.colorScheme]:Z})})}async function c$($){let J;try{J=await fetch($)}catch(V){throw`getDid: ${V.message}`}if(!J.ok)throw`response is not OK: ${J.status}`;return await J.json()}async function l$($){let J=M$.didResolverUrl+"/"+$;return w(await c$(J))}async function U$($){if(!$.startsWith("did:plc:"))throw"identity does not begin with did:plc:";let J=w((await l$($)).alsoKnownAs[0]),V="at://";if(J.startsWith(V))J=J.substring(V.length);return J}function n(){return{metadata:{client_id:w(P.clientMetadataJsonUrl),redirect_uri:w(P.oauthCallbackUrl)}}}(async()=>{let $=await h([z.userDid,z.userHandle,z.colorScheme]),J=$[z.colorScheme]||"dark",V=w(document.getElementById("darkModeToggle"));x$(V,J);let X=w(document.getElementById("content")),Z=w(document.getElementById("loginForm")),Q=w(document.getElementById("loggedInActions")),G=w(document.getElementById("bookmarkLink")),W=w(document.getElementById("logoutLink")),H=w(document.getElementById("switchAccLink")),Y=w(document.getElementById("identityInput")),q=w(document.getElementById("loginBtn")),B=w(document.getElementById("status")),x=$[z.userDid],_=$[z.userHandle];if(x){if(_)X.innerHTML=`Logged in as<br>${_}`,Y.value=_;Q.style.display="block";let j=(await h([z.bookmarkFeedUrl]))[z.bookmarkFeedUrl];G.href=j||O.bookmarkFeedUrl,W.addEventListener("click",async(M)=>{if(B.innerText==="Logging out")return;B.innerText="Logging out";let U=w(x);try{try{await P.init(),S(n());let D=await R(U,{allowStale:!0});await new d(D).signOut()}catch{await c(U)}await _$([z.userDid,z.userHandle])}catch(D){B.innerText=D;return}X.style.display="none",B.innerText="Logged out successfully!",Z.style.display="block",Q.style.display="none"}),H.addEventListener("click",(M)=>{Z.style.display="block",Q.style.display="none"}),_=await U$(x),X.innerHTML=`Logged in as<br>${_}`,Y.value=_}else X.innerHTML="Login here to start",Z.style.display="block";function K(){if(_&&Y.value!==_)q.innerText="Switch Account";else q.innerText="Login"}K(),Y.addEventListener("input",K),q.addEventListener("click",async(j)=>{j.preventDefault(),q.disabled=!0,q.style.cursor="progress",B.innerText="Setting up login page ...",Y.disabled=!0,Y.style.cursor="progress";try{await P.init(),S(n());let{identity:M,metadata:U}=await y(Y.value),D=await w$({metadata:U,identity:M,scope:"atproto transition:generic"});w(z$(w(D))).focus(),B.innerText="Check opened window / tab"}catch(M){K(),B.innerText=M,q.style.cursor="",q.disabled=!1,Y.disabled=!1,Y.style.cursor=""}return!1})})();
