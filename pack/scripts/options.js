class L{name;controller;signal;static storage;constructor($){if(!L.storage)try{L.storage=chrome.storage}catch{try{L.storage=browser.storage}catch{throw"Unsupported browser"}}this.name=$.name,this.controller=new AbortController,this.signal=this.controller.signal,this.sessions=this.createStore("sessions",({token:J})=>{if(J.refresh)return null;return J.expires_at??null}),this.states=this.createStore("states",(J)=>Date.now()+600000),this.dpopNonces=this.createStore("dpopNonces",(J)=>Date.now()+600000)}sessions;states;dpopNonces;dispose(){this.controller.abort()}createStore($,J){let X=`${this.name}:${$}`,Z=async(Y)=>{try{await L.storage.local.set({[X]:Y})}catch(G){console.error("Error persisting storage:",G)}},Q=async()=>{if(this.signal.aborted)throw new Error("store closed");try{return(await L.storage.local.get(X))[X]||{}}catch(Y){return console.error("Error reading storage:",Y),{}}},W=null;return W=setInterval(async()=>{if(this.signal.aborted)return;try{let Y=await Q(),G=Date.now(),w=!1;for(let V in Y){let f=Y[V].expiresAt;if(f!==null&&G>f)w=!0,delete Y[V]}if(w)await Z(Y)}catch(Y){if(Y.message.includes("Extension context invalidated.")){if(W)clearInterval(W);return}console.error("Error during cleanup:",Y)}},1e4),this.signal.addEventListener("abort",()=>clearInterval(W)),{async get(Y){let G=await Q(),w=G[Y];if(!w)return;let V=w.expiresAt;if(V!==null&&Date.now()>V){delete G[Y],await Z(G);return}return w.value},async set(Y,G){let w=await Q();w[Y]={expiresAt:J(G),value:G},await Z(w)},async delete(Y){let G=await Q();if(G[Y]!==void 0)delete G[Y],await Z(G)},async keys(){let Y=await Q();return Object.keys(Y)}}}}var C,b,K,v=($)=>{({client_id:C,redirect_uri:b}=$.metadata),K=new L({name:$.storageName??"atcute-oauth"})};class F extends Error{name="ResolverError"}class j extends Error{sub;name="TokenRefreshError";constructor($,J,X){super(J,X);this.sub=$}}class l extends Error{response;data;name="OAuthResponseError";error;description;constructor($,J){let X=a(r(J)?.error),Z=a(r(J)?.error_description),Q=X?`"${X}"`:"unknown",W=Z?`: ${Z}`:"",P=`OAuth ${Q} error${W}`;super(P);this.response=$,this.data=J,this.error=X,this.description=Z}get status(){return this.response.status}get headers(){return this.response.headers}}class u extends Error{response;status;name="FetchResponseError";constructor($,J,X){super(X);this.response=$,this.status=J}}var a=($)=>{return typeof $==="string"?$:void 0},r=($)=>{return typeof $==="object"&&$!==null&&!Array.isArray($)?$:void 0};var t=($)=>{return U$($,"#atproto_pds","AtprotoPersonalDataServer")},U$=($,J,X)=>{let Q=$.id+J,W=$.service?.find((P)=>P.id===J||P.id===Q);if(!W||W.type!==X||typeof W.serviceEndpoint!=="string")return;return T$(W.serviceEndpoint)},T$=($)=>{let J;try{J=new URL($)}catch{return}let X=J.protocol;if(J.hostname&&(X==="http:"||X==="https:"))return $};var s="https://public.api.bsky.app";var O=($)=>{return $.get("content-type")?.split(";")[0]};var e=($)=>{return $.startsWith("did:")};var f$=/^([a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*(?:\.[a-zA-Z]{2,}))$/,L$=async($)=>{let J=s+`/xrpc/com.atproto.identity.resolveHandle?handle=${$}`,X=await fetch(J);if(X.status===400)throw new F("domain handle not found");else if(!X.ok)throw new F("directory is unreachable");return(await X.json()).did},O$=async($)=>{let J=$.indexOf(":",4),X=$.slice(4,J),Z=$.slice(J+1),Q;if(X==="plc"){let W=await fetch(`https://plc.directory/${$}`);if(W.status===404)throw new F("did not found in directory");else if(!W.ok)throw new F("directory is unreachable");Q=await W.json()}else if(X==="web"){if(!f$.test(Z))throw new F("invalid identifier");let W=await fetch(`https://${Z}/.well-known/did.json`);if(!W.ok)throw new F("did document is unreachable");Q=await W.json()}else throw new F("unsupported did method");return Q},A$=async($)=>{let J=new URL("/.well-known/oauth-protected-resource",$),X=await fetch(J,{redirect:"manual",headers:{accept:"application/json"}});if(X.status!==200||O(X.headers)!=="application/json")throw new F("unexpected response");let Z=await X.json();if(Z.resource!==J.origin)throw new F("unexpected issuer");return Z},k$=async($)=>{let J=new URL("/.well-known/oauth-authorization-server",$),X=await fetch(J,{redirect:"manual",headers:{accept:"application/json"}});if(X.status!==200||O(X.headers)!=="application/json")throw new F("unexpected response");let Z=await X.json();if(Z.issuer!==J.origin)throw new F("unexpected issuer");if(!Z.client_id_metadata_document_supported)throw new F("authorization server does not support 'client_id_metadata_document'");if(!Z.pushed_authorization_request_endpoint)throw new F("authorization server does not support 'pushed_authorization request'");if(Z.response_types_supported){if(!Z.response_types_supported.includes("code"))throw new F("authorization server does not support 'code' response type")}return Z},S=async($)=>{let J;if(e($))J=$;else J=await L$($);let X=await O$(J),Z=t(X);if(!Z)throw new F("missing pds endpoint");return{identity:{id:J,raw:$,pds:new URL(Z)},metadata:await C$(Z)}};var C$=async($)=>{let J=await A$($);if(J.authorization_servers?.length!==1)throw new F("expected exactly one authorization server in the listing");let X=J.authorization_servers[0],Z=await k$(X);if(Z.protected_resources){if(!Z.protected_resources.includes(J.resource))throw new F("server is not in authorization server's jurisdiction")}return Z};var I$="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var $$=($=21)=>{let J="",X=$;while(X--)J+=I$[Math.random()*64|0];return J};var D=new TextEncoder,r$=navigator.locks,A=($)=>{let X=[];for(let Z=0;Z<$.byteLength;Z+=32768)X.push(String.fromCharCode.apply(null,$.subarray(Z,Z+32768)));return btoa(X.join("")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},J$=($)=>{try{let J=atob($.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"")),X=new Uint8Array(J.length);for(let Z=0;Z<J.length;Z++)X[Z]=J.charCodeAt(Z);return X}catch(J){throw new TypeError("invalid base64url",{cause:J})}},p=async($)=>{let J=D.encode($),X=await crypto.subtle.digest("SHA-256",J);return A(new Uint8Array(X))},X$=($)=>{return A(crypto.getRandomValues(new Uint8Array($)))},Z$=()=>{return X$(16)},Q$=async()=>{let $=X$(32);return{verifier:$,challenge:await p($),method:"S256"}};function I($,J){if($==null){J??="value is null/empty";let X=Error().stack;if(X){let Z=X.split(`
`);if(Z.length>2){let Q=Z[2].trimStart();throw Q=Q.replace(/^at/,""),Q=Q.trimStart(),`${Q}:
${typeof $}: ${J}`}}throw`${typeof $}: ${J}`}return $}var W$={name:"ECDSA",namedCurve:"P-256"},Y$=async()=>{let $=await crypto.subtle.generateKey(W$,!0,["sign","verify"]),J=await crypto.subtle.exportKey("pkcs8",$.privateKey),{ext:X,key_ops:Z,...Q}=await crypto.subtle.exportKey("jwk",$.publicKey);return{typ:"ES256",key:A(new Uint8Array(J)),jwt:A(D.encode(JSON.stringify({typ:"dpop+jwt",alg:"ES256",jwk:Q})))}},E$=($,J)=>{let X=J.jwt,Z=crypto.subtle.importKey("pkcs8",J$(J.key),W$,!0,["sign"]),Q=(W,P,Y,G)=>{let w=Date.now()/1000|0,V={iss:$,iat:w,jti:$$(12),htm:W,htu:P,nonce:Y,ath:G};return A(D.encode(JSON.stringify(V)))};return async(W,P,Y,G)=>{let w=Q(W,P,Y,G),V=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},await Z,D.encode(X+"."+w)),x=A(new Uint8Array(V));return X+"."+w+"."+x}},G$=($,J,X)=>{let Z=I(K),Q=I(Z.dpopNonces),W=E$($,J);return async(P,Y)=>{let G=Y==null&&P instanceof Request?P:new Request(P,Y),w=G.headers.get("authorization"),V=w?.startsWith("DPoP ")?await p(w.slice(5)):void 0,{method:x,url:f}=G,{origin:M}=new URL(f),q;try{q=await Q.get(M)}catch{}let U=await W(x,f,q,V);G.headers.set("dpop",U);let B=await fetch(G),T=B.headers.get("dpop-nonce");if(!T||T===q)return B;try{await Q.set(M,T)}catch{}if(!await b$(B,X))return B;if(P===G||Y?.body instanceof ReadableStream)return B;let k=await W(x,f,T,V),E=new Request(P,Y);return E.headers.set("dpop",k),await fetch(E)}},b$=async($,J)=>{if(J===void 0||!J){if($.status===401){let X=$.headers.get("www-authenticate");if(X?.startsWith("DPoP"))return X.includes('error="use_dpop_nonce"')}}if(J===void 0||J){if($.status===400&&O($.headers)==="application/json")try{let X=await $.clone().json();return typeof X==="object"&&X?.error==="use_dpop_nonce"}catch{return!1}}return!1};var w$=($,J)=>{let X={};for(let Z=0,Q=J.length;Z<Q;Z++){let W=J[Z];X[W]=$[W]}return X};class i{#J;#$;constructor($,J){this.#$=$,this.#J=G$(C,J,!0)}async request($,J){let X=this.#$[`${$}_endpoint`];if(!X)throw new Error(`no endpoint for ${$}`);let Z=await this.#J(X,{method:"post",headers:{"content-type":"application/json"},body:JSON.stringify({...J,client_id:C})});if(O(Z.headers)!=="application/json")throw new u(Z,2,"unexpected content-type");let Q=await Z.json();if(Z.ok)return Q;else throw new l(Z,Q)}async revoke($){try{await this.request("revocation",{token:$})}catch{}}async exchangeCode($,J){let X=await this.request("token",{grant_type:"authorization_code",redirect_uri:b,code:$,code_verifier:J});try{return await this.#Z(X)}catch(Z){throw await this.revoke(X.access_token),Z}}async refresh({sub:$,token:J}){if(!J.refresh)throw new j($,"no refresh token available");let X=await this.request("token",{grant_type:"refresh_token",refresh_token:J.refresh});if(!X.sub)throw new j($,"missing value for sub in token response");if($!==X.sub)throw new j($,`sub mismatch in token response; got ${X.sub}`);try{return this.#X(X)}catch(Z){throw await this.revoke(X.access_token),Z}}#X($){if(!$.sub)throw new TypeError("missing sub field in token response");if(!$.scope)throw new TypeError("missing scope field in token response");if($.token_type!=="DPoP")throw new TypeError("token response returned a non-dpop token");return{scope:$.scope,refresh:$.refresh_token,access:$.access_token,type:$.token_type,expires_at:typeof $.expires_in==="number"?Date.now()+$.expires_in*1000:void 0}}async#Z($){let J=$.sub;if(!J)throw new TypeError("missing sub field in token response");let X=this.#X($),Z=await S(J);if(Z.metadata.issuer!==this.#$.issuer)throw new TypeError(`issuer mismatch; got ${Z.metadata.issuer}`);return{token:X,info:{sub:J,aud:Z.identity.pds.href,server:w$(Z.metadata,["issuer","authorization_endpoint","introspection_endpoint","pushed_authorization_request_endpoint","revocation_endpoint","token_endpoint"])}}}}var q$=async({metadata:$,identity:J,scope:X})=>{let Z=Z$(),Q=await Q$(),W=await Y$(),P={redirect_uri:b,code_challenge:Q.challenge,code_challenge_method:Q.method,state:Z,login_hint:J?.raw,response_mode:"fragment",response_type:"code",display:"page",scope:X},Y=I(K);await I(Y.states).set(Z,{dpopKey:W,metadata:$,verifier:Q.verifier});let V=await new i($,W).request("pushed_authorization_request",P),x=new URL($.authorization_endpoint);return x.searchParams.set("client_id",C),x.searchParams.set("request_uri",V.request_uri),x};function z($,J){if($==null){J??="value is null/empty";let X=Error().stack;if(X){let Z=X.split(`
`);if(Z.length>2){let Q=Z[2].trimStart();throw Q=Q.replace(/^at/,""),Q=Q.trimStart(),`${Q}:
${typeof $}: ${J}`}}throw`${typeof $}: ${J}`}return $}function m($){if(!d.enable)return;if(d.tracing){let J=Error("").stack;if(J){let X=J.split(`
`);if(X.length>2){let Z=X[2].trimStart();Z=Z.replace(/^at/,""),Z=Z.trimStart(),console.log(Z),console.log($);return}}}console.log($)}function z$($){console.error($)}function P$($){let J=window.open($,"_blank");if(J)J.focus();return J}class n{container;timer;constructor(){this.timer=null,this.container=document.createElement("div"),this.container.classList.add("biskuvi-toast-container"),document.body.appendChild(this.container)}show($,J="info",X=3000){if(document.hidden)return;if(this.timer)clearTimeout(this.timer);let Z=new F$($,J),Q=this.container.lastChild;if(Q)try{this.container.removeChild(Q)}catch(W){if(W.name!=="NotFoundError")z$(W)}this.timer=setTimeout(()=>{Z.element.style.animation="slideOut 250ms ease-in",setTimeout(()=>{this.container.removeChild(Z.element)},250)},X),this.container.appendChild(Z.element)}}class F${element;constructor($,J){this.element=document.createElement("div"),this.element.classList.add("biskuvi-toast",J),this.element.textContent=$}}var H={userHandle:"biskuvi_user_handle",userDid:"biskuvi_user_did",language:"biskuvi_language",colorScheme:"biskuvi_color_scheme",bookmarkServerUrl:"biskuvi_bookmark_server_url",bookmarkFeedUrl:"biskuvi_bookmark_feed_url",clientMetadataJsonUrl:"biskuvi_client_metadata_json_url",oauthCallbackUrl:"biskuvi_oauth_callback_url"};async function H$($){switch($){case 1:return new V$}throw"Not implemented"}class V${async isBookmarked($){return(await(await this.fetch("/xrpc/app.biskuvi.bookmark.isBookmarked",$)).json()).is_bookmarked===!0}async arePostsBookmarked($){let X=await(await this.fetch("/xrpc/app.biskuvi.bookmark.arePostsBookmarked",null,{uris:$})).json();return z(X.uris)}async addBookmark($){await this.fetch("/xrpc/app.biskuvi.bookmark.addBookmark",$)}async removeBookmark($){await this.fetch("/xrpc/app.biskuvi.bookmark.removeBookmark",$)}async fetch($,J,X){let Z=z(N.bookmarkServerUrl)+$;if(J)Z+=`?uri=${J}`;let Q=z(N.oAuthUserAgent),W;if(X)W=await Q.handle(Z,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(X)});else W=await Q.handle(Z);if(!W.ok)throw new Error("Invalid response status");return W}}function j$(){try{return z(chrome)}catch{try{return z(browser)}catch{throw"Unsupported browser"}}}var o=j$();async function g($){return await o.storage.local.set($)}async function h($,J=[]){let X=$;if(J.length>0)X=X.filter((Z)=>!J.includes(Z));return await o.storage.local.get(X)}async function N$($){return await o.storage.local.remove($)}var B$={bskyUrl:"https://bsky.app",bookmarkPageUrlAlias:"/bookmarks",handleResolverUrl:"https://api.bsky.app",didResolverUrl:"https://plc.directory"},d={enable:!0,tracing:!1},_={language:"en",bookmarkServerUrl:"https://bookmarks.bskv.site",bookmarkFeedUrl:"https://bsky.app/profile/bookmarks.bskv.site/feed/bookmarks",clientMetadataJsonUrl:"https://bskv.site/client-metadata.json",oauthCallbackUrl:"https://bskv.site/atproto-oauth-callback"};class N{static userDid;static userHandle;static language;static bookmarkServerUrl;static bookmarkFeedUrl;static clientMetadataJsonUrl;static oauthCallbackUrl;static root;static oAuthSession;static oAuthUserAgent;static bookmarkManager;static toaster;static fallbackIsBookmarked;static async init(){N.bookmarkManager=await H$(1);let $=await h(Object.values(H));N.userDid=$[H.userDid],N.language=$[H.language]||_.language,N.bookmarkServerUrl=$[H.bookmarkServerUrl]||_.bookmarkServerUrl,N.bookmarkFeedUrl=$[H.bookmarkFeedUrl]||_.bookmarkFeedUrl,N.clientMetadataJsonUrl=$[H.clientMetadataJsonUrl]||_.clientMetadataJsonUrl,N.oauthCallbackUrl=$[H.oauthCallbackUrl]||_.oauthCallbackUrl,N.toaster=new n}}function M$($,J){let X=document.body;if(document.documentElement.style.colorScheme=J,X.classList.add(J),J!="light")$.checked=!0;setTimeout((Z)=>{let Q=document.documentElement.style.colorScheme;document.documentElement.style.cssText+=`color-scheme: ${Q}; --trTime: 0.3s;`},1000),$.addEventListener("change",async()=>{let Z=X.classList.contains("dark")?"dark":"light",Q=Z=="light"?"dark":"light";X.classList.replace(Z,Q),document.documentElement.style.colorScheme=Q,await g({[H.colorScheme]:Q})})}async function D$($){let J;try{J=await fetch($)}catch(X){throw`getDid: ${X.message}`}if(!J.ok)throw`response is not OK: ${J.status}`;return await J.json()}async function m$($){let J=B$.didResolverUrl+"/"+$;return z(await D$(J))}async function _$($){if(!$.startsWith("did:plc:"))throw"identity does not begin with did:plc:";let J=z((await m$($)).alsoKnownAs[0]),X="at://";if(J.startsWith(X))J=J.substring(X.length);return J}function x$(){return{metadata:{client_id:z(N.clientMetadataJsonUrl),redirect_uri:z(N.oauthCallbackUrl)}}}(async()=>{let $=await h(Object.values(H)),J=$[H.colorScheme]||"dark",X=z(document.getElementById("darkModeToggle"),"missing darkModeToggle input");M$(X,J);let Z=z(document.getElementById("userHandle"),"missing userHandle input"),Q=z(document.getElementById("userDid"),"missing userDid input"),W=z(document.getElementById("loginBtn"),"missing loginBtn input"),P=z(document.getElementById("loginStatus"),"missing loginStatus input"),Y=z(document.getElementById("settingsStatus"),"missing settingsStatus input"),G=$[H.userDid],w=$[H.userHandle];if(G){if(Q.value=G,w)Z.value=w;w=await _$(G),Z.value=w}function V(){if(w&&Z.value!==w)Q.value="",W.innerText="Switch Account";else{if(G)Q.value=G;W.innerText="Login"}}V(),Z.addEventListener("input",V),W.addEventListener("click",async(M)=>{M.preventDefault(),W.disabled=!0,W.style.cursor="progress",P.innerText="Setting up login page ...",Z.disabled=!0,Z.style.cursor="progress";try{await N.init(),v(x$());let{identity:q,metadata:U}=await S(Z.value),B=await q$({metadata:U,identity:q,scope:"atproto transition:generic"});z(P$(z(B))).focus(),P.innerText="Check opened window / tab"}catch(q){V(),P.innerText=q,W.style.cursor="",W.disabled=!1,Z.disabled=!1,Z.style.cursor=""}return!1});for(let M in _){let q=document.getElementById(M);if(q){if(q.value=$[H[M]]||_[M],q.type==="text")q.autocapitalize="off",q.autocomplete="off",q.spellcheck=!1;q.addEventListener("change",(U)=>{if(q){if(!q.value||q.value.trim().length<1)q.value=_[M];let B=q.value;if(q.type==="url")q.value=B.replace(/\/+$/,"")}})}}z(document.getElementById("saveBtn")).addEventListener("click",f);async function f(M){M.preventDefault();let q=await h(Object.values(H)),U={},B=[];for(let T in _){let y=document.getElementById(T);if(y){let k=y.value,E=_[T],R=H[T],c=q[R];if(k)if(k===E){if(c)B.push(R)}else if(k===c);else U[R]=k;else if(c===E)B.push(R)}}if(Object.keys(U).length>0||B.length>0)await g(U),m("Stored:"),m(U),await N$(B),m("Removed:"),m(B),Y.textContent="Settings saved successfully!";else Y.textContent="No new changes. Nothing is saved.";return setTimeout((T)=>Y.textContent="",3000),!1}})();
