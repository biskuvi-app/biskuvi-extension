class K{name;controller;signal;static storage;constructor(w){if(!K.storage)try{K.storage=chrome.storage}catch{try{K.storage=browser.storage}catch{throw"Unsupported browser"}}this.name=w.name,this.controller=new AbortController,this.signal=this.controller.signal,this.sessions=this.createStore("sessions",({token:$})=>{if($.refresh)return null;return $.expires_at??null}),this.states=this.createStore("states",($)=>Date.now()+600000),this.dpopNonces=this.createStore("dpopNonces",($)=>Date.now()+600000)}sessions;states;dpopNonces;dispose(){this.controller.abort()}createStore(w,$){let H=`${this.name}:${w}`,J=async(Q)=>{try{await K.storage.local.set({[H]:Q})}catch(q){console.error("Error persisting storage:",q)}},V=async()=>{if(this.signal.aborted)throw new Error("store closed");try{return(await K.storage.local.get(H))[H]||{}}catch(Q){return console.error("Error reading storage:",Q),{}}},X=null;return X=setInterval(async()=>{if(this.signal.aborted)return;try{let Q=await V(),q=Date.now(),P=!1;for(let W in Q){let F=Q[W].expiresAt;if(F!==null&&q>F)P=!0,delete Q[W]}if(P)await J(Q)}catch(Q){if(Q.message.includes("Extension context invalidated.")){if(X)clearInterval(X);return}console.error("Error during cleanup:",Q)}},1e4),this.signal.addEventListener("abort",()=>clearInterval(X)),{async get(Q){let q=await V(),P=q[Q];if(!P)return;let W=P.expiresAt;if(W!==null&&Date.now()>W){delete q[Q],await J(q);return}return P.value},async set(Q,q){let P=await V();P[Q]={expiresAt:$(q),value:q},await J(P)},async delete(Q){let q=await V();if(q[Q]!==void 0)delete q[Q],await J(q)},async keys(){let Q=await V();return Object.keys(Q)}}}}var D,v,x,l=(w)=>{({client_id:D,redirect_uri:v}=w.metadata),x=new K({name:w.storageName??"atcute-oauth"})};class B extends Error{name="LoginError"}class s extends Error{name="AuthorizationError"}class _ extends Error{name="ResolverError"}class O extends Error{sub;name="TokenRefreshError";constructor(w,$,H){super($,H);this.sub=w}}class g extends Error{response;data;name="OAuthResponseError";error;description;constructor(w,$){let H=qw(Pw($)?.error),J=qw(Pw($)?.error_description),V=H?`"${H}"`:"unknown",X=J?`: ${J}`:"",G=`OAuth ${V} error${X}`;super(G);this.response=w,this.data=$,this.error=H,this.description=J}get status(){return this.response.status}get headers(){return this.response.headers}}class e extends Error{response;status;name="FetchResponseError";constructor(w,$,H){super(H);this.response=w,this.status=$}}var qw=(w)=>{return typeof w==="string"?w:void 0},Pw=(w)=>{return typeof w==="object"&&w!==null&&!Array.isArray(w)?w:void 0};var Ww=(w)=>{return vw(w,"#atproto_pds","AtprotoPersonalDataServer")},vw=(w,$,H)=>{let V=w.id+$,X=w.service?.find((G)=>G.id===$||G.id===V);if(!X||X.type!==H||typeof X.serviceEndpoint!=="string")return;return uw(X.serviceEndpoint)},uw=(w)=>{let $;try{$=new URL(w)}catch{return}let H=$.protocol;if($.hostname&&(H==="http:"||H==="https:"))return w};var zw="https://public.api.bsky.app";var h=(w)=>{return w.get("content-type")?.split(";")[0]};var Uw=(w)=>{return w.startsWith("did:")};var pw=/^([a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*(?:\.[a-zA-Z]{2,}))$/,dw=async(w)=>{let $=zw+`/xrpc/com.atproto.identity.resolveHandle?handle=${w}`,H=await fetch($);if(H.status===400)throw new _("domain handle not found");else if(!H.ok)throw new _("directory is unreachable");return(await H.json()).did},iw=async(w)=>{let $=w.indexOf(":",4),H=w.slice(4,$),J=w.slice($+1),V;if(H==="plc"){let X=await fetch(`https://plc.directory/${w}`);if(X.status===404)throw new _("did not found in directory");else if(!X.ok)throw new _("directory is unreachable");V=await X.json()}else if(H==="web"){if(!pw.test(J))throw new _("invalid identifier");let X=await fetch(`https://${J}/.well-known/did.json`);if(!X.ok)throw new _("did document is unreachable");V=await X.json()}else throw new _("unsupported did method");return V},nw=async(w)=>{let $=new URL("/.well-known/oauth-protected-resource",w),H=await fetch($,{redirect:"manual",headers:{accept:"application/json"}});if(H.status!==200||h(H.headers)!=="application/json")throw new _("unexpected response");let J=await H.json();if(J.resource!==$.origin)throw new _("unexpected issuer");return J},ow=async(w)=>{let $=new URL("/.well-known/oauth-authorization-server",w),H=await fetch($,{redirect:"manual",headers:{accept:"application/json"}});if(H.status!==200||h(H.headers)!=="application/json")throw new _("unexpected response");let J=await H.json();if(J.issuer!==$.origin)throw new _("unexpected issuer");if(!J.client_id_metadata_document_supported)throw new _("authorization server does not support 'client_id_metadata_document'");if(!J.pushed_authorization_request_endpoint)throw new _("authorization server does not support 'pushed_authorization request'");if(J.response_types_supported){if(!J.response_types_supported.includes("code"))throw new _("authorization server does not support 'code' response type")}return J},Fw=async(w)=>{let $;if(Uw(w))$=w;else $=await dw(w);let H=await iw($),J=Ww(H);if(!J)throw new _("missing pds endpoint");return{identity:{id:$,raw:w,pds:new URL(J)},metadata:await rw(J)}};var rw=async(w)=>{let $=await nw(w);if($.authorization_servers?.length!==1)throw new _("expected exactly one authorization server in the listing");let H=$.authorization_servers[0],J=await ow(H);if(J.protected_resources){if(!J.protected_resources.includes($.resource))throw new _("server is not in authorization server's jurisdiction")}return J};var aw="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var Mw=(w=21)=>{let $="",H=w;while(H--)$+=aw[Math.random()*64|0];return $};var u=new TextEncoder,ww=navigator.locks,p=(w)=>{let H=[];for(let J=0;J<w.byteLength;J+=32768)H.push(String.fromCharCode.apply(null,w.subarray(J,J+32768)));return btoa(H.join("")).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},_w=(w)=>{try{let $=atob(w.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"")),H=new Uint8Array($.length);for(let J=0;J<$.length;J++)H[J]=$.charCodeAt(J);return H}catch($){throw new TypeError("invalid base64url",{cause:$})}},Aw=async(w)=>{let $=u.encode(w),H=await crypto.subtle.digest("SHA-256",$);return p(new Uint8Array(H))};function E(w,$){if(w==null){$??="value is null/empty";let H=Error().stack;if(H){let J=H.split(`
`);if(J.length>2){let V=J[2].trimStart();throw V=V.replace(/^at/,""),V=V.trimStart(),`${V}:
${typeof w}: ${$}`}}throw`${typeof w}: ${$}`}return w}var tw={name:"ECDSA",namedCurve:"P-256"};var sw=(w,$)=>{let H=$.jwt,J=crypto.subtle.importKey("pkcs8",_w($.key),tw,!0,["sign"]),V=(X,G,Q,q)=>{let P=Date.now()/1000|0,W={iss:w,iat:P,jti:Mw(12),htm:X,htu:G,nonce:Q,ath:q};return p(u.encode(JSON.stringify(W)))};return async(X,G,Q,q)=>{let P=V(X,G,Q,q),W=await crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},await J,u.encode(H+"."+P)),U=p(new Uint8Array(W));return H+"."+P+"."+U}},d=(w,$,H)=>{let J=E(x),V=E(J.dpopNonces),X=sw(w,$);return async(G,Q)=>{let q=Q==null&&G instanceof Request?G:new Request(G,Q),P=q.headers.get("authorization"),W=P?.startsWith("DPoP ")?await Aw(P.slice(5)):void 0,{method:U,url:F}=q,{origin:f}=new URL(F),I;try{I=await V.get(f)}catch{}let t=await X(U,F,I,W);q.headers.set("dpop",t);let N=await fetch(q),c=N.headers.get("dpop-nonce");if(!c||c===I)return N;try{await V.set(f,c)}catch{}if(!await ew(N,H))return N;if(G===q||Q?.body instanceof ReadableStream)return N;let cw=await X(U,F,c,W),Gw=new Request(G,Q);return Gw.headers.set("dpop",cw),await fetch(Gw)}},ew=async(w,$)=>{if($===void 0||!$){if(w.status===401){let H=w.headers.get("www-authenticate");if(H?.startsWith("DPoP"))return H.includes('error="use_dpop_nonce"')}}if($===void 0||$){if(w.status===400&&h(w.headers)==="application/json")try{let H=await w.clone().json();return typeof H==="object"&&H?.error==="use_dpop_nonce"}catch{return!1}}return!1};var fw=(w,$)=>{let H={};for(let J=0,V=$.length;J<V;J++){let X=$[J];H[X]=w[X]}return H};class C{#$;#w;constructor(w,$){this.#w=w,this.#$=d(D,$,!0)}async request(w,$){let H=this.#w[`${w}_endpoint`];if(!H)throw new Error(`no endpoint for ${w}`);let J=await this.#$(H,{method:"post",headers:{"content-type":"application/json"},body:JSON.stringify({...$,client_id:D})});if(h(J.headers)!=="application/json")throw new e(J,2,"unexpected content-type");let V=await J.json();if(J.ok)return V;else throw new g(J,V)}async revoke(w){try{await this.request("revocation",{token:w})}catch{}}async exchangeCode(w,$){let H=await this.request("token",{grant_type:"authorization_code",redirect_uri:v,code:w,code_verifier:$});try{return await this.#J(H)}catch(J){throw await this.revoke(H.access_token),J}}async refresh({sub:w,token:$}){if(!$.refresh)throw new O(w,"no refresh token available");let H=await this.request("token",{grant_type:"refresh_token",refresh_token:$.refresh});if(!H.sub)throw new O(w,"missing value for sub in token response");if(w!==H.sub)throw new O(w,`sub mismatch in token response; got ${H.sub}`);try{return this.#H(H)}catch(J){throw await this.revoke(H.access_token),J}}#H(w){if(!w.sub)throw new TypeError("missing sub field in token response");if(!w.scope)throw new TypeError("missing scope field in token response");if(w.token_type!=="DPoP")throw new TypeError("token response returned a non-dpop token");return{scope:w.scope,refresh:w.refresh_token,access:w.access_token,type:w.token_type,expires_at:typeof w.expires_in==="number"?Date.now()+w.expires_in*1000:void 0}}async#J(w){let $=w.sub;if(!$)throw new TypeError("missing sub field in token response");let H=this.#H(w),J=await Fw($);if(J.metadata.issuer!==this.#w.issuer)throw new TypeError(`issuer mismatch; got ${J.metadata.issuer}`);return{token:H,info:{sub:$,aud:J.identity.pds.href,server:fw(J.metadata,["issuer","authorization_endpoint","introspection_endpoint","pushed_authorization_request_endpoint","revocation_endpoint","token_endpoint"])}}}}var i=new Map,b=async(w,$)=>{$?.signal?.throwIfAborted();let H=V0;if($?.noCache)H=$0;else if($?.allowStale)H=w0;let J;while(J=i.get(w)){try{let{isFresh:Q,value:q}=await J;if(Q||H(q))return q}catch{}$?.signal?.throwIfAborted()}let V=async()=>{let Q=E(x),P=await E(Q.sessions).get(w);if(P&&H(P))return{isFresh:!1,value:P};let W=await H0(w,P);return await $w(w,W),{isFresh:!0,value:W}},X;if(ww)X=ww.request(`atcute-oauth:${w}`,V);else X=V();if(X=X.finally(()=>i.delete(w)),i.has(w))throw new Error("concurrent request for the same key");i.set(w,X);let{value:G}=await X;return G},$w=async(w,$)=>{try{let H=E(x);await E(H.sessions).set(w,$)}catch(H){throw await J0($),H}},Iw=async(w)=>{let $=E(x);await E($.sessions).delete(w)};var w0=()=>!0,$0=()=>!1,H0=async(w,$)=>{if($===void 0)throw new O(w,"session deleted by another tab");let{dpopKey:H,info:J,token:V}=$,X=new C(J.server,H);try{let G=await X.refresh({sub:J.sub,token:V});return{dpopKey:H,info:J,token:G}}catch(G){if(G instanceof g&&G.status===400&&G.error==="invalid_grant")throw new O(w,"session was revoked",{cause:G});throw G}},J0=async({dpopKey:w,info:$,token:H})=>{await new C($.server,w).revoke(H.refresh??H.access)},V0=({token:w})=>{let $=w.expires_at;return $==null||Date.now()+60000<=$};var Ew=async(w)=>{let $=w.get("iss"),H=w.get("state"),J=w.get("code"),V=w.get("error");if(!H||!(J||V))throw new B("missing parameters");let X=E(x),G=E(X.states),Q=await G.get(H);if(Q)await G.delete(H);else throw new B("unknown state provided");let{dpopKey:q,metadata:P}=Q;if(V)throw new s(w.get("error_description")||V);if(!J)throw new B("missing code parameter");if($===null)throw new B("missing issuer parameter");else if($!==P.issuer)throw new B("issuer mismatch");let W=new C(P,q),{info:U,token:F}=await W.exchangeCode(J,Q.verifier),f=U.sub,I={dpopKey:q,info:U,token:F};return await $w(f,I),I};class Hw{session;#$;#w;constructor(w){this.session=w,this.#$=d(D,w.dpopKey,!1)}get sub(){return this.session.info.sub}getSession(w){let $=b(this.session.info.sub,w);return $.then((H)=>{this.session=H}).finally(()=>{this.#w=void 0}),this.#w=$}async signOut(){let w=this.session.info.sub;try{let{dpopKey:$,info:H,token:J}=await b(w,{allowStale:!0});await new C(H.server,$).revoke(J.refresh??J.access)}finally{await Iw(w)}}async handle(w,$){await this.#w;let H=new Headers($?.headers),J=this.session,V=new URL(w,J.info.aud);H.set("authorization",`${J.token.type} ${J.token.access}`);let X=await this.#$(V,{...$,headers:H});if(!X0(X))return X;try{if(this.#w)J=await this.#w;else J=await this.getSession()}catch{return X}if($?.body instanceof ReadableStream)return X;return V=new URL(w,J.info.aud),H.set("authorization",`${J.token.type} ${J.token.access}`),await this.#$(V,{...$,headers:H})}}var X0=(w)=>{if(w.status!==401)return!1;let $=w.headers.get("www-authenticate");return $!=null&&($.startsWith("Bearer ")||$.startsWith("DPoP "))&&$.includes('error="invalid_token"')};var z={userHandle:"biskuvi_user_handle",userDid:"biskuvi_user_did",language:"biskuvi_language",colorScheme:"biskuvi_color_scheme",bookmarkServerUrl:"biskuvi_bookmark_server_url",bookmarkFeedUrl:"biskuvi_bookmark_feed_url",clientMetadataJsonUrl:"biskuvi_client_metadata_json_url",oauthCallbackUrl:"biskuvi_oauth_callback_url"};function Z(w,$){if(w==null){$??="value is null/empty";let H=Error().stack;if(H){let J=H.split(`
`);if(J.length>2){let V=J[2].trimStart();throw V=V.replace(/^at/,""),V=V.trimStart(),`${V}:
${typeof w}: ${$}`}}throw`${typeof w}: ${$}`}return w}async function xw(w){switch(w){case 1:return new Kw}throw"Not implemented"}class Kw{async isBookmarked(w){return(await(await this.fetch("/xrpc/app.biskuvi.bookmark.isBookmarked",w)).json()).is_bookmarked===!0}async arePostsBookmarked(w){let H=await(await this.fetch("/xrpc/app.biskuvi.bookmark.arePostsBookmarked",null,{uris:w})).json();return Z(H.uris)}async addBookmark(w){await this.fetch("/xrpc/app.biskuvi.bookmark.addBookmark",w)}async removeBookmark(w){await this.fetch("/xrpc/app.biskuvi.bookmark.removeBookmark",w)}async fetch(w,$,H){let J=Z(Y.bookmarkServerUrl)+w;if($)J+=`?uri=${$}`;let V=Z(Y.oAuthUserAgent),X;if(H)X=await V.handle(J,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(H)});else X=await V.handle(J);if(!X.ok)throw new Error("Invalid response status");return X}}function Q0(){try{return Z(chrome)}catch{try{return Z(browser)}catch{throw"Unsupported browser"}}}var Ow=Q0();async function n(w){return await Ow.storage.local.set(w)}async function R(w,$=[]){let H=w;if($.length>0)H=H.filter((J)=>!$.includes(J));return await Ow.storage.local.get(H)}async function Cw(){return(await R([z.userDid]))[z.userDid]}var M={bskyUrl:"https://bsky.app",bookmarkPageUrlAlias:"/bookmarks",handleResolverUrl:"https://api.bsky.app",didResolverUrl:"https://plc.directory"},Jw={enable:!0,tracing:!1},m={language:"en",bookmarkServerUrl:"https://bookmarks.bskv.site",bookmarkFeedUrl:"https://bsky.app/profile/bookmarks.bskv.site/feed/bookmarks",clientMetadataJsonUrl:"https://bskv.site/client-metadata.json",oauthCallbackUrl:"https://bskv.site/atproto-oauth-callback"};class Y{static userDid;static userHandle;static language;static bookmarkServerUrl;static bookmarkFeedUrl;static clientMetadataJsonUrl;static oauthCallbackUrl;static root;static oAuthSession;static oAuthUserAgent;static bookmarkManager;static toaster;static fallbackIsBookmarked;static async init(){Y.bookmarkManager=await xw(1);let w=await R(Object.values(z));Y.userDid=w[z.userDid],Y.language=w[z.language]||m.language,Y.bookmarkServerUrl=w[z.bookmarkServerUrl]||m.bookmarkServerUrl,Y.bookmarkFeedUrl=w[z.bookmarkFeedUrl]||m.bookmarkFeedUrl,Y.clientMetadataJsonUrl=w[z.clientMetadataJsonUrl]||m.clientMetadataJsonUrl,Y.oauthCallbackUrl=w[z.oauthCallbackUrl]||m.oauthCallbackUrl,Y.toaster=new Vw}}function o(w){if(!Jw.enable)return;if(Jw.tracing){let $=Error("").stack;if($){let H=$.split(`
`);if(H.length>2){let J=H[2].trimStart();J=J.replace(/^at/,""),J=J.trimStart(),console.log(J),console.log(w);return}}}console.log(w)}function A(w){console.error(w)}function y(w){return new Promise(($)=>{let H=null;function J(){let V=document.querySelector(w);if(V){if(H)H.disconnect();return $(V),!0}else return!1}if(!J())H=new MutationObserver(J),H.observe(document.body,{childList:!0,subtree:!0})})}function L(w,$,H,J){let V=null;function X(){let Q=!document.hidden&&w();if(Q){if(clearInterval(Z(V)),J)setTimeout(G,J);$(Q)}}function G(){V=setInterval(X,H)}return G(),Z(V)}function Lw(w,$=null,H=!0){return new Promise((J,V)=>{setTimeout(()=>{if(H)return J($);else return V(new Error($))},w)})}class Vw{container;timer;constructor(){this.timer=null,this.container=document.createElement("div"),this.container.classList.add("biskuvi-toast-container"),document.body.appendChild(this.container)}show(w,$="info",H=3000){if(document.hidden)return;if(this.timer)clearTimeout(this.timer);let J=new Tw(w,$),V=this.container.lastChild;if(V)try{this.container.removeChild(V)}catch(X){if(X.name!=="NotFoundError")A(X)}this.timer=setTimeout(()=>{J.element.style.animation="slideOut 250ms ease-in",setTimeout(()=>{this.container.removeChild(J.element)},250)},H),this.container.appendChild(J.element)}}class Tw{element;constructor(w,$){this.element=document.createElement("div"),this.element.classList.add("biskuvi-toast",$),this.element.textContent=w}}var Y0={en:{Bookmark:"Bookmark",Bookmarks:"Bookmarks"},ca:{Bookmark:"Marcador"},de:{Bookmark:"Lesezeichen"},es:{Bookmark:"Marcador"},fi:{Bookmark:"Kirjanmerkki"},fr:{Bookmark:"Marque-page"},ga:{Bookmark:"Leabharmharc"},hi:{Bookmark:"बुकमार्क"},id:{Bookmark:"Penanda buku"},it:{Bookmark:"Segnalibro"},ja:{Bookmark:"ブックマーク",Bookmarks:"ブックマーク"},ko:{Bookmark:"서표"},"pt-BR":{Bookmark:"Marcador"},ru:{Bookmark:"Закладка"},tr:{Bookmark:"Yer imi"},uk:{Bookmark:"Закладка"},"zh-CN":{Bookmark:"书签"},"zh-TW":{Bookmark:"書籤"},"zh-HK":{Bookmark:"書籤"}};function k(w){let $=Z(Y.language),H=Y0[$];if(!H)return A("Invalid language${}"),w;let J=H[w];if(!J)return A(`No translation in ${$} for ${w}`),w;return J}class jw{svgPath;constructor(w){this.svgPath=Z(w.querySelector("path")),Z(this.svgPath.parentNode).setAttribute("viewBox","-38 -51 460 614")}setColor(w){this.svgPath.setAttribute("fill",w)}setIcon(w){this.svgPath.setAttribute("d",w)}}class Nw extends jw{active(){this.iconActive(),this.colorActive()}normal(){this.iconNormal(),this.colorNormal()}iconActive(){this.setIcon("M0 48V487.7C0 501.1 10.9 512 24.3 512c5 0 9.9-1.5 14-4.4L192 400 345.7 507.6c4.1 2.9 9 4.4 14 4.4c13.4 0 24.3-10.9 24.3-24.3V48c0-26.5-21.5-48-48-48H48C21.5 0 0 21.5 0 48z")}iconNormal(){this.setIcon("M0 48C0 21.5 21.5 0 48 0l0 48 0 393.4 130.1-92.9c8.3-6 19.6-6 27.9 0L336 441.4 336 48 48 48 48 0 336 0c26.5 0 48 21.5 48 48l0 440c0 9-5 17.2-13 21.3s-17.6 3.4-24.9-1.8L192 397.5 37.9 507.5c-7.3 5.2-16.9 5.9-24.9 1.8S0 497 0 488L0 48z")}colorNormal(){this.setColor("var(--bmNormal)")}colorActive(){this.setColor("var(--bmActive)")}colorError(){this.setColor("var(--bmError)")}}class Zw{btnFrame;btn;btnIcon;atUri;isBookmarked;lockClick;constructor(w,$){this.btnFrame=w.cloneNode(!0),this.btnFrame.style.opacity="1",this.btn=Z(this.btnFrame.firstChild),this.btn.style.display="none",this.btn.setAttribute("aria-label",k("Bookmark")),this.btn.removeAttribute("data-testid"),this.btn.replaceChildren(Z(this.btn.firstChild)),this.btnIcon=new Nw(this.btn),this.atUri=$,this.isBookmarked=!1,this.lockClick=!1,this.btnIcon.normal(),this.btn.classList.add("bm"),this.btn.style.display="block",this.btn.onclick=this.btnOnClick.bind(this)}getElement(){return this.btnFrame}setStatus(w){if(this.isBookmarked=w,w)this.btnIcon.active();else this.btnIcon.normal()}async btnOnClick(w){if(w.stopPropagation(),this.lockClick)return;this.lockClick=!0;let $=Y.toaster,H=Z(Y.bookmarkManager),J=this.btnIcon;if(this.isBookmarked){J.colorNormal();try{await H.removeBookmark(this.atUri),this.isBookmarked=!1,J.iconNormal(),$.show("Removed from bookmarks!","info")}catch{J.colorError(),J.iconActive(),$.show("Error removing from bookmarks","error")}}else{J.iconActive();try{await H.addBookmark(this.atUri),this.isBookmarked=!0,J.colorActive(),$.show("Added to bookmarks!","info")}catch{J.colorError(),J.iconNormal(),$.show("Error adding to bookmarks","error")}}this.lockClick=!1}}function Qw(w){return Z(Y.root).querySelector(w)}function Dw(w){return Z(Y.root).querySelectorAll(w)}class T{static cache={};static getDid(w){let $=T.cache[w];if($){if(Date.now()-$.time<60000)return $.did;delete T.cache[w]}return null}static setDid(w,$){let H=Object.keys(T.cache);if(H.length>50)delete T.cache[H[0]];T.cache[w]={did:$,time:Date.now()}}}async function Bw(w){let $;try{$=await fetch(w)}catch(H){throw`getDid: ${H.message}`}if(!$.ok)throw`response is not OK: ${$.status}`;return await $.json()}async function q0(w){let $=M.handleResolverUrl+"/xrpc/com.atproto.identity.resolveHandle?handle="+w;return Z(await Bw($))}async function Yw(w){if(w.startsWith("did:plc:"))return w;let $=T.getDid(w);if($)return $;return $=Z((await q0(w)).did),T.setDid(w,$),$}async function P0(w){let $=M.didResolverUrl+"/"+w;return Z(await Bw($))}async function r(w){if(!w.startsWith("did:plc:"))throw"identity does not begin with did:plc:";let $=Z((await P0(w)).alsoKnownAs[0]),H="at://";if($.startsWith(H))$=$.substring(H.length);return $}async function W0(w){let $=w.split("/profile/");if($.length!=2)throw"bmBtnOnClick: invalid splitProfileFromUrl.length";let H=$[1].split("/post/");if(H.length!=2)throw"bmBtnOnClick: invalid splitPostFromUrl.length";let J=Z(H[0]),V=Z(H[1]);return`at://${await Yw(J)}/app.bsky.feed.post/${V}`}async function hw(w){let $=w.getAttribute("atUri");if(!$)$=await W0(await z0(w));return w.setAttribute("atUri",$),$}async function z0(w){let $=w.getAttribute("postUrl");if($)return $;function H(G){return G.startsWith(`${M.bskyUrl}/profile/`)}function J(G){return G.indexOf("/post/")>-1}let V;for(let G of w.querySelectorAll("a[href]")){let Q=G.href;if(H(Q)){if(J(Q))$=Q;else V=Q;if(V&&$){if($.indexOf(V)==0)return $;throw`Mismatch:
${V}
${$}`}}}let X=window.location.href;if(H(X)&&J(X)){w=Z(Z(w.parentNode).parentNode);let G=Z(w.firstChild),Q=Z(G.querySelector("a"));if(H(Q.href)){let q=Q.href.split("/profile/")[1];if(q.indexOf("/")<0){let P=q,U=X.split("/profile/")[1].split("/")[0];if(U===P)return X;else if(U.startsWith("did:plc:")){let F=await Yw(P);if(U===F)return X}}}}throw"No post url"}function yw(){L(U0,F0,1000,2500)}function U0(){let w=Dw("button:not(.bd)[data-testid='likeBtn']");if(w&&w.length>0)return w}function F0(w){o(`Found ${w.length} like button(s)`);let $=0,H=0,J=w.length,V=0,X=20,G=[],Q={};async function q(P){o(`Checking ${P.length} URIs`);let W=Z(Y.bookmarkManager);function U(){for(let F of P)W.isBookmarked(F).then((f)=>f?Q[F](!0):null).catch((f)=>A(f))}if(Y.fallbackIsBookmarked)U();else W.arePostsBookmarked(P).then((F)=>{for(let f of F)Q[f](!0)}).catch((F)=>{A(F),Y.fallbackIsBookmarked=!0,U()})}for(let P of w)P.classList.add("bd"),(async()=>{let W=Z(P.parentNode),U=Z(W.parentNode);if(U.classList.contains("bd")){A("Bookmark button is already processing! Skipping ...");return}U.classList.add("bd");let F=Z(U.parentNode),f=await Promise.race([hw(F),Lw(30000)]);if(typeof f==="string"){let I=new Zw(W,f);G.push(f),Q[f]=I.setStatus.bind(I),U.insertBefore(I.getElement(),W.nextSibling),$+=1,V+=1}else A("Error getting URI from post:"),A(F),H+=1;if(V==X||$==J){o(`buffer: ${V} (max: ${X}) || count: ${$} (error: ${H})/${J}`);let I=$-V,t=G.slice(I,I+X);V=0,q(t).catch((N)=>Y.toaster.show(`Error getting bookmark data: ${N}`,"warning"))}})().catch((W)=>{A("Error creating bookmark button from like button:"),A(P),A(W)})}var j={left:{isShown:!1},bottom:{isShown:!1}};function Rw(){L(A0,f0,50,750),L(M0,_0,50,750)}function M0(){let w=Qw("div > div > div > div > nav > div:nth-child(3):has(> svg)");if(w){if(!j.bottom.isShown){let $=w.classList;if($.contains("bd"))return;return $.add("bd"),j.bottom.isShown=!0,w}}else if(j.bottom.isShown)j.bottom.isShown=!1}function _0(w){let $=w.cloneNode(!0),H=Z(Y.bookmarkFeedUrl),J=Z($.querySelector("path"));J.setAttribute("d","M0 48C0 21.5 21.5 0 48 0l0 48 0 393.4 130.1-92.9c8.3-6 19.6-6 27.9 0L336 441.4 336 48 48 48 48 0 336 0c26.5 0 48 21.5 48 48l0 440c0 9-5 17.2-13 21.3s-17.6 3.4-24.9-1.8L192 397.5 37.9 507.5c-7.3 5.2-16.9 5.9-24.9 1.8S0 497 0 488L0 48z"),Z(J.parentNode).setAttribute("viewBox","-38 -51 460 614"),$.onclick=()=>{return window.location.href=H,!1},Z(w.parentNode).insertBefore($,w.nextSibling)}function A0(){let w=Qw('div > div > div > div > nav > a:not(.bd)[href="/messages"]');if(w){if(!j.left.isShown){let $=w.classList;if($.contains("bd"))return;return $.add("bd"),j.left.isShown=!0,w}}else if(j.left.isShown)j.left.isShown=!1}function f0(w){let $=w.cloneNode(!0),H=k("Bookmarks");if($.classList.add("bm"),$.setAttribute("aria-label",H),$.href=M.bookmarkPageUrlAlias,$.onclick=()=>{return window.location.href=Z(Y.bookmarkFeedUrl),!1},$.children.length==2){let V=$.lastElementChild;if(V)V.innerText=H}let J=$.querySelector("div > svg > path");if(J){let V=function(){let X=null;if($.children.length==2){if(X=$.lastElementChild,X)if(w.children.length==2)X.style.display="block";else X.style.display="none"}if(window.location.href.endsWith(M.bookmarkPageUrlAlias)){if(J&&$.getAttribute("bm-active")!=="true")J.setAttribute("d","M0 48V487.7C0 501.1 10.9 512 24.3 512c5 0 9.9-1.5 14-4.4L192 400 345.7 507.6c4.1 2.9 9 4.4 14 4.4c13.4 0 24.3-10.9 24.3-24.3V48c0-26.5-21.5-48-48-48H48C21.5 0 0 21.5 0 48z"),$.setAttribute("bm-active","true");if(X&&X.style.fontWeight!=="800")X.style.fontWeight="800"}else{if(J&&$.getAttribute("bm-active")!=="false")J.setAttribute("d","M0 48C0 21.5 21.5 0 48 0l0 48 0 393.4 130.1-92.9c8.3-6 19.6-6 27.9 0L336 441.4 336 48 48 48 48 0 336 0c26.5 0 48 21.5 48 48l0 440c0 9-5 17.2-13 21.3s-17.6 3.4-24.9-1.8L192 397.5 37.9 507.5c-7.3 5.2-16.9 5.9-24.9 1.8S0 497 0 488L0 48z"),$.setAttribute("bm-active","false");if(X&&X.style.fontWeight!=="400")X.style.fontWeight="400"}};$.setAttribute("bm-active","false"),J.setAttribute("d","M0 48C0 21.5 21.5 0 48 0l0 48 0 393.4 130.1-92.9c8.3-6 19.6-6 27.9 0L336 441.4 336 48 48 48 48 0 336 0c26.5 0 48 21.5 48 48l0 440c0 9-5 17.2-13 21.3s-17.6 3.4-24.9-1.8L192 397.5 37.9 507.5c-7.3 5.2-16.9 5.9-24.9 1.8S0 497 0 488L0 48z"),Z(J.parentNode).setAttribute("viewBox","-38 -51 460 614"),setInterval(V,250)}Z(w.parentNode).insertBefore($,w.nextSibling)}async function I0(){y("div[role=tab]").then((w)=>{Z(w.parentNode).style.display="none"}),y("button[data-testid=pinBtn]").then((w)=>{let $=Z(w.parentNode),H=Z($.parentNode);H.style.paddingTop="8px",H.style.paddingBottom="8px",H.style.paddingLeft="16px",H.style.paddingRight="16px",H.style.fontSize="150%",H.style.fontWeight="600",H.innerText=k("Bookmarks")})}var S={hasEntered:!1,hasNavigatedAway:!1};function kw(){lw()}function lw(){S.hasEntered=!1,S.hasNavigatedAway=!1,L(x0,E0,500)}function E0(){if(!S.hasEntered)S.hasEntered=!0,history.replaceState(null,"",M.bookmarkPageUrlAlias),I0().then(()=>{}),K0()}function x0(){return document.location.href.split(M.bskyUrl)[1]===Z(Y.bookmarkFeedUrl)}function K0(){L(O0,C0,250)}function O0(){let w=document.location.href;if(w.split(M.bskyUrl)[1]!==M.bookmarkPageUrlAlias)return w}function C0(w){S.hasNavigatedAway=!0,history.replaceState(null,"",Z(Y.bookmarkFeedUrl)),history.pushState(null,"",w),lw()}function gw(){kw(),y("div#root").then((w)=>{Y.root=w,yw(),Rw()})}function a(){return{metadata:{client_id:Z(Y.clientMetadataJsonUrl),redirect_uri:Z(Y.oauthCallbackUrl)}}}function bw(){let w=Z(Y.oAuthSession);if(Date.now()>=Z(w.token.expires_at))return Y.toaster.show("Session expired. Please login.","warning"),!0;return!1}function mw(w,$){let H=document.body;if(document.documentElement.style.colorScheme=$,H.classList.add($),$!="light")w.checked=!0;setTimeout((J)=>{let V=document.documentElement.style.colorScheme;document.documentElement.style.cssText+=`color-scheme: ${V}; --trTime: 0.3s;`},1000),w.addEventListener("change",async()=>{let J=H.classList.contains("dark")?"dark":"light",V=J=="light"?"dark":"light";H.classList.replace(J,V),document.documentElement.style.colorScheme=V,await n({[z.colorScheme]:V})})}async function Sw(){await y(".container");let w=Z(document.getElementById("oauthTitle")),$=Z(document.getElementById("oauthInfo"));w.innerText="Finalizing authentication",$.innerText="Please wait. You will be redirected to Bluesky.";let J=(await R([z.colorScheme]))[z.colorScheme]||"dark",V=Z(document.getElementById("darkModeToggle"));mw(V,J);try{let X=new URLSearchParams(location.hash.slice(1));l(a());let Q=(await Ew(X)).info.sub,q=await r(Q);await n({[z.userDid]:Q,[z.userHandle]:q});let P=await R([z.userDid,z.userHandle]);if(Q!==P[z.userDid]||q!==P[z.userHandle]){w.innerText="Unable to store authorization info",$.innerText="Please contact support if the problem persists.";return}history.replaceState(null,"",location.pathname+location.search),window.location.href=M.bskyUrl}catch(X){w.innerText="An error has occurred",$.innerText=`${X}
Please retry login or contact support if the problem persists.`}}function L0(){let w=window.location.href;Y.init().then(async()=>{if(l(a()),w.startsWith(M.bskyUrl)){Y.toaster.show("Biskuvi - Initializing session","info",2000);let $=await Cw();if($){try{Y.oAuthSession=await b($)}catch(H){if(H.name==="TokenRefreshError"&&H.message.includes("session deleted by another tab"))Y.toaster.show("Logged out. Please log in again","warning");else A(H),Y.toaster.show("Biskuvi - Error initializing session","error");return}if(bw()){Y.toaster.show("Biskuvi - Session expired. Please log in again","warning",7500);return}else Y.oAuthUserAgent=new Hw(Y.oAuthSession),Y.userHandle=await r($),Y.toaster.show(`Biskuvi - Logged in as ${Y.userHandle}`,"success"),gw()}else Y.toaster.show("Biskuvi - Open extension menu to login","warning",7500)}else if(w.startsWith(Z(Y.oauthCallbackUrl)))Sw().then(($)=>null)})}L0();
